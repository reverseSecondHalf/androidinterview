# 1. Crash治理策略
## 1.1. 开发阶段
提交代码review  
静态代码检查工具  
提倡使用Kotlin
## 1.2. 测试阶段
Monkey自动化测试
自动化篡改服务端返回值为空看客户端代码的健壮性
## 1.3. 灰度阶段
注意和线上版本对比，分析发现出哪些是新增的crash，对新增的尽量都解决，如果不能解决的需要评估上线后会带来多少的占比
## 1.4. 上线后阶段
刚上线后需要密切关注崩溃率变化。  
上线后一段时间（差不多大部分都升上来后），需要将线上的一些崩溃分配给指定开发，提前解决问题。
# 2. Crash治理工具
1. 线上监控系统
2. 第三方sdk修改工具
3. 代码插桩工具  
4. Java Crash兜底框架：通过配置下发解决线上可以被暂时忽略掉的crash或者无法解决的系统crash但可以进行兜底处理的问题。
# 3. Crash分析思路
## 3.1. 一般的业务crash
这类crash一般按堆栈直接修复即可，对于空指针类型的，需要注意下是否真的是简单的加个空指针判断就行了，是否是逻辑上有问题。
## 3.2. Android系统问题
这类问题一般是规避。比如：
1. android8.0透明activity如果设置了portrait属性直接崩溃，可以直接hook基类activity解决掉。
2. andoridP上开始的webview的setDataDirectorySuffix崩溃，需要在启动时为每个进程设置不同的路径。 
    
无法规避的走兜底策略catch住。
## 3.3. 堆栈无法定位的
三步走：
业务和系统日志 -> 缩小范围 -> 需要更多信息
### 3.3.1. 业务和系统日志
如果根据已有的信息，比如业务日志、系统日志、用户崩溃前的操作行为
可利用的信息如：日志、用户崩溃前的操作行为（activity、fragment级别），定位到问题并解决。
### 3.3.2. 缩小范围
根据现有可利用的信息，看看是否能缩小范围，比如缩小到某个业务甚至某个功能，又或者crash是否有某种分布趋势（如只在某个机型或者android版本上出现），根据这些我们再去查看这些业务最近有啥变更：比如开启了某个实验、新增了哪些代码，又或者是我们拿特定设备或机型尝试复现看看。

### 3.3.3. 需要更多信息
   如果以上还不能解决，看看是否是需要通过发版再增加一些额外信息来解决。比如遇到过一种空指针：
   ```
   03-01 11:50:11.836: E/AndroidRuntime(21136): FATAL EXCEPTION: main  03-01 11:50:11.836: E/AndroidRuntime(21136): java.lang.NullPointerException  03-01 11:50:11.836: E/AndroidRuntime(21136):    at android.view.ViewGroup.dispatchGetDisplayList(ViewGroup.java:3147)  03-01 11:50:11.836: E/AndroidRuntime(21136):    at android.view.View.getDisplayList(View.java:12646)  03-01 11:50:11.836: E/AndroidRuntime(21136):    at android.view.View.getDisplayList(View.java:12754)
   ```
   单从这个无法定位到是哪处代码的removeView移除导致了问题，如果通过排查代码也无法找到的话，只能通过插桩手段在所有调用removeView相关的操作处加上堆栈记录，然后在崩溃上报时把堆栈记录带上去，下次就能大概率定位到问题。

# 4. OOM治理
## 4.1. 尽量用64位包，能大幅降低OOM相关的崩溃
## 4.2. 32位OOM治理黑科技
[快速缓解 32 位 Android 环境下虚拟内存地址空间不足的“黑科技”](http://androidos.net.cn/doc/2021/7/29/532.html)
### 4.2.1. 堆缩减（android5-7和8-11的方案不同）
具体可参考：阿里开源的[Patrons](https://github.com/alibaba/Patrons)库  
收益很大，几百MB起步。
### 4.2.2. 释放Webview预分配的内存
能带来100多MB
### 4.2.3. 线程栈空间减半
用不了这么多栈空间，减半能带来100多MB
### 4.2.4. 兜底自杀
实在定位不了的，如果内存到达了一定阈值，可以看看在合适的时机，比如用户退后台时做进程自杀处理。
