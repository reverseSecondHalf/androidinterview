# 1. 合规的主要内容
对于客户端来讲合规工作主要包含如下几个方面：
## 1.1. 隐私政策
新安装之前必须得同意隐私政策，另外还有服务协议等， 这些在设置里也都有入口。
## 1.2. 合规相关的功能
因合规需要而必须有的功能，比如青少年模式、双清单、最小模式等。
## 1.3. 权限
使用权限前，需要征求用户同意并告知。
## 1.4. 隐私
各种隐私数据在隐私协议同意前不得采集、敏感数据采集的频次得有控制、敏感数据经网络传输需要加密等。
## 1.5. 广告
广告这块处理隐私的处理这方面，还有针对广告独有的一些规定，比如开机屏广告得有“关闭”按钮、广告得有三要素等。
# 2. 合规的流程
## 2.1. 需求收集阶段
如果需求涉及接入第三方sdk，需要事先评估下第三方sdk在合规方面的风险程度。
## 2.2. 开发阶段
接入第三方sdk时，评估所需要的敏感信息，看以什么方式给，最好做到我们自己能控制，而不是任由第三方sdk自己去获取。
## 2.3. 测试阶段
使用工具进行合规检测，将不合规的问题扼杀在萌芽。
## 2.4. 交付阶段
交付到应用商店时如果遇到问题，及时和商店交涉解决，最好能要到具体的堆栈信息。
# 3. 工具
## 3.1. 检测工具
1. 自研工具：比如写的sdk嵌入在app里，有一定作用，但也有局限，不像下面两个工具在定制rom层面进行检测完备。  
2. [史宾格](https://spc.baidu.com):比较好用，有静态和动态检测，动态检测比较重要，一般可以制定核心测试用例，每个版本在上线前的测试阶段进行一轮测试。  
3. 第三方检测机构：好处是会及时更新最新的政策，测的也比较专业。
4. dex搜索工具，可以检查到apk里的敏感api调用，毕竟一般的app都有插件，或者第三方sdk里有些把核心功能放到apk里。
## 3.2. 修改工具
利用字节码插桩工具，可以：
1. 方便的全局对隐私api进行hook
2. 因各种原因无法更新第三方sdk来解决不合规的问题，需要插桩工具来自己修改
缺点：
1. apk里的没法hook
2. native层的调用或者反射之类的没法监测
# 4. 技术要点
针对第一大点里合规的主要内容里，针对权限和隐私模块说下常见的技术方案。
## 4.1. 权限
国内一般要求在使用权限时需要明确说明用这个权限来干什么，可以在申请权限时顶部弹tips说明用途。建议：
1. 整个app有统一的权限框架，框架里向系统代为申请所需要的权限，同时根据调用方输入的文案在权限申请时同步展示给用户。
2. 对于第三方sdk，有些没法改的，要通过字节码插桩机制，hook住权限申请的地方，做兜底处理，至少能做到activity级别的区分，根据activity不同来定制化文案展示。
3. 对于代码在apk里的，需要推动apk提供方去修改。
## 4.2. 隐私同意前不能调用敏感API
基础库提供方法给各业务调用，同时对各敏感API要做收口处理，在收口处做兜底判断是否同意了隐私协议。
## 4.3. 永久不变信息经网络传输
要慎重，尤其是IMEI这种，能不传就不传，传的话需要使用加密手段。广告这种尽量让其往OAID或者卓信ID（没用过，但是是永久不变的）考虑。
## 4.4. 敏感信息要注意频次
通过收口API
## 4.5. 字节码插桩的兜底机制
对敏感信息调用的API，要梳理清楚，统一成基础库，给各业务使用，需要考虑到跨进程调用，同时最好有云控手段来控制频次的多少等。